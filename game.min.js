(function(a){var c=document.getElementById("screen"),b=c.getContext("2d"),d=8,e=0,f=0,g=0,l=document.getElementById("ship"),h=l.getContext("2d"),m=document.getElementById("shadow"),k=m.getContext("2d"),p=new Image,q=new Image;p.src="img/shade.png";q.src="img/s_shade.png";k.translate(400,400);h.translate(100,100);a.setPov=function(b){b=c.relMouseCoords(b);e=!1;f+=(b.x-c.width/2)*d;g+=(b.y-c.height/2)*d;b=-1;for(var a=Infinity,n=0;n<LVL.nodes.length;n++){var h=LVL.nodes[n],h=Math.sqrt((h.x-f)*(h.x-
f)+(h.y-g)*(h.y-g));h<a&&(b=n,a=h)}a<50*d&&(e=LVL.nodes[b],f=LVL.nodes[b].x,g=LVL.nodes[b].y)};a.zoom_out=function(){d*=2};a.zoom_in=function(){d/=2};a.update_pov=function(){e&&(f=e.x,g=e.y)};a.width=c.width;a.height=c.height;a.translate_coords=function(b,a,e){return{x:Math.round((b-f)/d+c.width/2),y:Math.round((a-g)/d+c.height/2),s:Math.round(e/d+1)}};a.clear=function(){b.clearRect(0,0,c.width,c.height);h.clearRect(-100,-100,200,200)};a.draw_icon=function(a){k.clearRect(-400,-400,800,800);100<a.s?
(k.drawImage(this.icon,-400,-400),k.rotate(-this.lightangle),k.drawImage(p,-400,-400),k.rotate(this.lightangle),b.drawImage(m,a.x-a.s/2,a.y-a.s/2,a.s,a.s)):(k.drawImage(this.s_icon,-50,-50),k.rotate(-this.lightangle),k.drawImage(q,-50,-50),k.rotate(this.lightangle),b.drawImage(m,350,350,100,100,a.x-a.s/2,a.y-a.s/2,a.s,a.s))};a.draw_gate=function(a){b.drawImage(this.icon,128*this.frame,0,128,128,a.x-a.s/2,a.y-a.s/2,a.s,a.s);this.frame++;this.frame%=30};a.draw_star=function(a){b.beginPath();b.arc(a.x,
a.y,2*a.s,0,2*Math.PI);var d=b.createRadialGradient(a.x,a.y,a.s/4,a.x,a.y,2*a.s);d.addColorStop(0,"rgba("+this.color_r+", "+this.color_g+", "+this.color_b+", 0.6)");d.addColorStop(.1,"rgba("+this.color_r+", "+this.color_g+", "+this.color_b+", 0.2)");d.addColorStop(1,"rgba("+this.color_r+", "+this.color_g+", "+this.color_b+", 0.0)");b.fillStyle=d;b.fill();b.drawImage(this.icon,a.x-a.s,a.y-a.s,2*a.s,2*a.s)};a.draw_ship=function(a){h.rotate(this.rotation);h.drawImage(this.icon,-100,-100);h.rotate(-this.rotation);
b.drawImage(l,a.x-a.s/2,a.y-a.s/2,a.s,a.s)};a.draw_ripple=function(d){var c=a.translate_coords(d.x,d.y,0);b.strokeStyle="#aadddd";b.beginPath();b.arc(c.x,c.y,d.age,0,2*Math.PI);b.stroke();d.age+=1};a.draw_trace=function(d){d=a.translate_coords(d.x,d.y);b.fillStyle="#eeeeee";b.fillRect(d.x,d.y,1,1)};a.draw_frame=function(b){for(var d=0;d<b.length;d++){var e=a.translate_coords(b[d].x,b[d].y,b[d].size);e.x>-e.s&&e.x>-e.s&&e.x<c.width+e.s&&e.y<c.height+e.s&&b[d].draw(e)}}})(window.FX=window.FX||{});(function(){var a=0,c=["ms","moz","webkit","o"],b;for(b=0;b<c.length&&!window.requestAnimationFrame;b++)window.requestAnimationFrame=window[c[b]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[c[b]+"CancelAnimationFrame"]||window[c[b]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var f=(new Date).getTime(),g=Math.max(0,16-(f-a)),l=window.setTimeout(function(){b(f+g)},g);a=f+g;return l});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();function loadScript(a,c){var b=document.getElementsByTagName("head")[0],d=document.createElement("script");d.type="text/javascript";d.src=a;d.onreadystatechange=c;d.onload=c;b.appendChild(d)}function relMouseCoords(a){var c=0,b=0,d=0,e=0,d=this;do c+=d.offsetLeft-d.scrollLeft,b+=d.offsetTop-d.scrollTop;while(d=d.offsetParent);d=a.pageX-c;e=a.pageY-b;return{x:d,y:e}}HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;
(function(){function a(){c.width=window.innerWidth;c.height=window.innerHeight;FX.width=c.width;FX.height=c.height}var c=document.getElementById("screen");window.addEventListener("resize",a,!1);a()})();(function(a){var c=0,b=0;arrowsPressed=function(a){38==a.keyCode&&(b=12);40==a.keyCode&&(b=-12);37==a.keyCode&&(c=-.2);39==a.keyCode&&(c=.2);return!1};arrowsReleased=function(a){38==a.keyCode&&(b=0);40==a.keyCode&&(b=0);37==a.keyCode&&(c=0);39==a.keyCode&&(c=0);return!1};a.state=function(){return{rotation:c,thrust:b}};zoom_handler=function(a){a.stopPropagation();var b=0;a||(a=window.event);a.wheelDelta?b=a.wheelDelta/60:a.detail&&(b=-a.detail/2);0>b&&FX.zoom_out();0<b&&FX.zoom_in()};a.init_controls=
function(){document.onkeydown=arrowsPressed;document.onkeyup=arrowsReleased;document.onclick=FX.setPov;window.addEventListener&&document.addEventListener("DOMMouseScroll",zoom_handler,!1);document.onmousewheel=zoom_handler}})(window.CTRL=window.CTRL||{});(function(a){a.G=20;a.gravity=function(c){for(var b=0;b<c.length;b++){"planet"==c[b].type&&(c[b].farlight=Infinity);for(var d=0;d<c.length;d++)if(b!=d){var e=c[b],f=c[d];if(!(1>=f.mass)){var g=f.x-e.x,l=f.y-e.y,h=Math.sqrt(g*g+l*l)+1,m=a.G*f.mass/(h*h*h);e.vx+=m*g;e.vy+=m*l;if(h/2>e.size+f.size)e.oncontact(f);"star"==f.type&&"planet"==e.type&&e.farlight>h&&(e.lightangle=-Math.acos(g/h),0>l&&(e.lightangle*=-1),e.farlight=h)}}}};a.orbit=function(c,b){var d=c.x-b.x,e=c.y-b.y,f=Math.sqrt(d*d+e*e),g=Math.sqrt(a.G*
c.mass*b.mass/(f*f)*f/b.mass);b.vx=c.vx+e*g/f;b.vy=c.vy-d*g/f}})(window.PHYS=window.PHYS||{});(function(a){var c=Math.random;a.node=function(a,d,c,f,g){this.type="node";this.x=a;this.y=d;this.vx=f;this.vy=g;this.mass=c;this.size=100;this.draw=function(){};this.oncontact=function(){};return this};a.planet=function(b,d,e,f,g){b=new a.node(b,d,e,f,g);b.type="planet";b.icon=new Image;b.s_icon=new Image;d=Math.floor(6*c())+".png";b.icon.src="img/planet"+d;b.s_icon.src="img/s_planet"+d;b.draw=FX.draw_icon;b.size=2*Math.sqrt(e);b.farlight=Infinity;b.lightangle=0;return b};a.star=function(b,d,e,f,
g){b=new a.node(b,d,e,f,g);b.type="star";b.color_r=100+Math.floor(150*c());b.color_g=100+Math.floor(150*c());b.color_b=100+Math.floor(150*c());b.icon=new Image;b.icon.src="img/star.png";b.draw=FX.draw_star;b.size=2*Math.sqrt(e);return b};a.ship=function(b,d,c,f,g){b=new a.node(b,d,c,f,g);b.type="ship";b.icon=new Image;b.icon.src="img/rocket.png";b.rotation=-Math.PI/4;b.thrust=0;b.draw=FX.draw_ship;return b};a.gate=function(b,c,e,f,g){b=new a.node(b,c,e,f,g);b.type="gate";b.icon=new Image;b.icon.src=
"img/sprites.png";b.draw=FX.draw_gate;b.frame=0;b.size=128;return b}})(window.ACTS=window.ACTS||{});(function(a){a.nodes=[];a.masscount=0;a.shipindex=0;var c=Math.random;a.init_world=function(){a.nodes.push(new ACTS.star(3200*c()-1600,3200*c()-1600,3E5,0,0));a.nodes.push(new ACTS.planet(a.nodes[0].x+2500,a.nodes[0].y-1940,5E3,0,0));a.shipindex=a.nodes.length;a.nodes.push(new ACTS.ship(a.nodes[1].x+100,a.nodes[1].y-120,1,0,0));PHYS.orbit(a.nodes[0],a.nodes[1]);PHYS.orbit(a.nodes[1],a.nodes[2]);a.masscount=a.shipindex;a.nodes.push(new ACTS.gate(a.nodes[2].x-150,a.nodes[2].y+100,1,0,0));PHYS.orbit(a.nodes[1],
a.nodes[3]);a.add_random_object()};a.add_random_object=function(){.7<c()?a.nodes.push(new ACTS.star(6400*c()-3200,6400*c()-3200,1E4+5E5*c(),100*c()-50,100*c()-50)):a.nodes.push(new ACTS.planet(6400*c()-3200,6400*c()-3200,1E3+1E4*c(),100*c()-50,100*c()-50))}})(window.LVL=window.LVL||{});var fpscount=document.getElementById("fps"),objcount=document.getElementById("objcount"),messages=document.getElementById("messages"),ripples=[],traces=[],frameId=NaN,dt,nextDT;function init(){dt=Date.now();nextDT=dt+200;CTRL.init_controls();LVL.init_world();document.getElementById("feeder").onclick=function(a){LVL.add_random_object();a.stopPropagation();return!1}}
function main_loop(){FX.clear();FX.update_pov();frameId=requestAnimationFrame(main_loop);var a=Date.now()-dt;dt=Date.now();var c=Math.ceil(200/a),a=LVL.nodes[LVL.shipindex];dt>nextDT&&(nextDT=dt+200,PHYS.gravity(LVL.nodes),a.thrust&&(a.vx+=a.thrust*Math.cos(a.rotation),a.vy+=a.thrust*Math.sin(a.rotation),ripples.unshift({x:a.x,y:a.y,age:0})),(40<ripples.length||0<ripples.length&&40<ripples[ripples.length-1].age)&&ripples.pop(),fpscount.innerHTML="FPS: "+5*c,objcount.innerHTML="Objects population: "+
LVL.nodes.length);a.thrust&&!ripples.length&&ripples.unshift({x:a.x,y:a.y,age:0});for(var b=0;b<ripples.length;b++)FX.draw_ripple(ripples[b]);FX.draw_frame(LVL.nodes);LVL.nodes.forEach(function(a){a.x+=a.vx/c;a.y+=a.vy/c});s=CTRL.state();a.rotation+=s.rotation;a.thrust=s.thrust}window.onload=function(){init();main_loop()};
